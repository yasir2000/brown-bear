name: ğŸ”’ Security Audit

on:
  schedule:
    # Run weekly security audit on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'composer.json'
      - 'composer.lock'
      - '.github/workflows/security.yml'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'
  PHP_VERSION: '8.0'

jobs:
  # =====================================================
  # Dependency Vulnerability Scanning
  # =====================================================
  dependency-scan:
    name: ğŸ“¦ Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          composer install --no-dev --optimize-autoloader

      - name: ğŸ” JavaScript Security Audit
        run: |
          echo "ğŸ” Scanning JavaScript dependencies..."
          pnpm audit --audit-level moderate --json > js-audit.json || true

          # Count vulnerabilities
          if [ -s js-audit.json ]; then
            echo "âš ï¸ JavaScript vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No JavaScript vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” PHP Security Audit
        run: |
          echo "ğŸ” Scanning PHP dependencies..."
          composer audit --format=json > php-audit.json || true

          if [ -s php-audit.json ]; then
            echo "âš ï¸ PHP vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No PHP vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload Audit Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-reports
          path: |
            js-audit.json
            php-audit.json
          retention-days: 90

  # =====================================================
  # Container Security Scanning
  # =====================================================
  container-scan:
    name: ğŸ³ Container Security
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        image: [web, realtime, reverse-proxy]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Container Image
        run: |
          docker build -t brownbear/${{ matrix.image }}:security-scan -f tools/docker/${{ matrix.image }}/Dockerfile .

      - name: ğŸ›¡ï¸ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: brownbear/${{ matrix.image }}:security-scan
          format: sarif
          output: trivy-${{ matrix.image }}.sarif

      - name: ğŸ“¤ Upload Trivy Scan Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.image }}.sarif
          category: container-${{ matrix.image }}

      - name: ğŸ›¡ï¸ Run Grype Vulnerability Scanner
        uses: anchore/scan-action@v3
        with:
          image: brownbear/${{ matrix.image }}:security-scan
          fail-build: false
          severity-cutoff: medium

      - name: ğŸ“Š Container Security Summary
        run: |
          echo "## ğŸ³ Container Security: ${{ matrix.image }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Trivy scan completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Grype scan completed" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Secret Scanning
  # =====================================================
  secret-scan:
    name: ğŸ•µï¸ Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --json --output=trufflehog-results.json

      - name: ğŸ” GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Secret Scan Summary
        run: |
          echo "## ğŸ•µï¸ Secret Scanning Results" >> $GITHUB_STEP_SUMMARY

          if [ -f trufflehog-results.json ] && [ -s trufflehog-results.json ]; then
            echo "âš ï¸ Potential secrets detected by TruffleHog" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No secrets detected by TruffleHog" >> $GITHUB_STEP_SUMMARY
          fi

          echo "âœ… GitLeaks scan completed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Secret Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: |
            trufflehog-results.json
            gitleaks-report.json
          retention-days: 90

  # =====================================================
  # Static Application Security Testing (SAST)
  # =====================================================
  sast-scan:
    name: ğŸ”¬ SAST Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ›¡ï¸ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, php
          queries: security-and-quality

      - name: ğŸ—ï¸ Build Application
        run: pnpm run build

      - name: ğŸ›¡ï¸ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: ğŸ” ESLint Security Scan
        run: |
          pnpm run lint:security || true
          echo "âœ… ESLint security scan completed" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Semgrep Security Scan
        uses: semgrep/semgrep-action@v1
        continue-on-error: true

  # =====================================================
  # Infrastructure Security
  # =====================================================
  infrastructure-scan:
    name: ğŸ—ï¸ Infrastructure Security
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Terraform Security Scan
        if: hashFiles('**/*.tf') != ''
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true

      - name: ğŸ” Kubernetes Security Scan
        if: hashFiles('**/*.yaml', '**/*.yml') != ''
        run: |
          # Install kubesec
          curl -sSX GET "https://api.github.com/repos/controlplaneio/kubesec/releases/latest" \
            | grep '"browser_download_url":' \
            | grep linux \
            | cut -d '"' -f 4 \
            | xargs curl -sSL -o kubesec
          chmod +x kubesec

          # Scan Kubernetes manifests
          find . -name "*.yaml" -o -name "*.yml" | grep -E "(k8s|kubernetes|manifests)" | while read file; do
            if [ -f "$file" ]; then
              echo "Scanning $file"
              ./kubesec scan "$file" || true
            fi
          done

      - name: ğŸ” Docker Compose Security Scan
        run: |
          echo "ğŸ” Analyzing Docker Compose security..."

          # Check for security issues in docker-compose files
          find . -name "docker-compose*.yml" | while read file; do
            echo "Analyzing $file"

            # Check for privileged containers
            if grep -q "privileged.*true" "$file"; then
              echo "âš ï¸ Privileged containers found in $file"
            fi

            # Check for host network mode
            if grep -q "network_mode.*host" "$file"; then
              echo "âš ï¸ Host network mode found in $file"
            fi

            # Check for bind mounts to sensitive paths
            if grep -qE "/(etc|proc|sys):" "$file"; then
              echo "âš ï¸ Potentially dangerous bind mounts found in $file"
            fi
          done

      - name: ğŸ“Š Infrastructure Security Summary
        run: |
          echo "## ğŸ—ï¸ Infrastructure Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker Compose security analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Kubernetes manifest scanning completed" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # License Compliance
  # =====================================================
  license-compliance:
    name: âš–ï¸ License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âš–ï¸ Check JavaScript Licenses
        run: |
          echo "âš–ï¸ Checking JavaScript dependency licenses..."

          # Install license checker
          npm install -g license-checker

          # Generate license report
          license-checker --json --out js-licenses.json --excludePrivatePackages

          # Check for problematic licenses
          if license-checker --failOn 'GPL;AGPL;LGPL;CPAL;OSL' --excludePrivatePackages; then
            echo "âœ… No problematic licenses found in JavaScript dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Potentially problematic licenses detected in JavaScript dependencies" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âš–ï¸ Check PHP Licenses
        run: |
          echo "âš–ï¸ Checking PHP dependency licenses..."

          # Check composer.lock for license information
          if [ -f composer.lock ]; then
            # Extract license information from composer.lock
            jq -r '.packages[] | "\(.name): \(.license // ["Unknown"])"' composer.lock > php-licenses.txt
            echo "âœ… PHP license information extracted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ composer.lock not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload License Reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            js-licenses.json
            php-licenses.txt
          retention-days: 90

  # =====================================================
  # Security Policy Validation
  # =====================================================
  policy-validation:
    name: ğŸ“‹ Policy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Check Security Policy
        run: |
          echo "ğŸ“‹ Validating security policies..."

          # Check if SECURITY.md exists
          if [ -f SECURITY.md ]; then
            echo "âœ… SECURITY.md file found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ SECURITY.md file missing" >> $GITHUB_STEP_SUMMARY
          fi

          # Check if .env.example exists and doesn't contain secrets
          if [ -f .env.example ]; then
            if grep -qE "(password|secret|key|token).*=" .env.example; then
              if grep -qE "(password|secret|key|token).*=\s*$" .env.example; then
                echo "âœ… .env.example contains placeholder values" >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ .env.example may contain actual secrets" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… .env.example security check passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Check for common security files
          security_files=("SECURITY.md" ".github/SECURITY.md" "NOTICE" "LICENSE")
          for file in "${security_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ $file missing" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # =====================================================
  # Security Report Generation
  # =====================================================
  security-report:
    name: ğŸ“„ Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, secret-scan, sast-scan, infrastructure-scan, license-compliance, policy-validation]
    if: always()

    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“„ Generate Security Report
        run: |
          echo "# ğŸ”’ Security Audit Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "**Repository:** ${{ github.repository }}" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md

          echo "## ğŸ“Š Scan Results Summary" >> security-report.md
          echo "" >> security-report.md
          echo "| Component | Status | Details |" >> security-report.md
          echo "|-----------|--------|---------|" >> security-report.md
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} | JavaScript & PHP dependencies |" >> security-report.md
          echo "| Container Scan | ${{ needs.container-scan.result }} | Docker images |" >> security-report.md
          echo "| Secret Scan | ${{ needs.secret-scan.result }} | TruffleHog & GitLeaks |" >> security-report.md
          echo "| SAST Scan | ${{ needs.sast-scan.result }} | CodeQL & Semgrep |" >> security-report.md
          echo "| Infrastructure | ${{ needs.infrastructure-scan.result }} | Docker Compose & K8s |" >> security-report.md
          echo "| License Compliance | ${{ needs.license-compliance.result }} | License validation |" >> security-report.md
          echo "| Policy Validation | ${{ needs.policy-validation.result }} | Security policies |" >> security-report.md
          echo "" >> security-report.md

          echo "## ğŸ¯ Recommendations" >> security-report.md
          echo "" >> security-report.md
          echo "- âœ… Keep dependencies updated regularly" >> security-report.md
          echo "- âœ… Review and rotate secrets periodically" >> security-report.md
          echo "- âœ… Monitor security advisories for used components" >> security-report.md
          echo "- âœ… Implement security training for development team" >> security-report.md
          echo "- âœ… Regular penetration testing" >> security-report.md

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: security-report.md
          retention-days: 365

      - name: ğŸ“¢ Security Summary
        run: |
          echo "## ğŸ”’ Security Audit Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Scan**: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container Security**: ${{ needs.container-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Detection**: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Static Analysis**: ${{ needs.sast-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure**: ${{ needs.infrastructure-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **License Compliance**: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy Validation**: ${{ needs.policy-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“„ **Comprehensive security report generated and uploaded**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Create Security Issue on Critical Findings
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Security Audit Alert - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ğŸš¨ Security Audit Alert

            **Date**: ${new Date().toISOString()}
            **Workflow**: ${{ github.run_id }}

            Critical security issues have been detected during the automated security audit.

            ### ğŸ” Failed Security Checks:
            ${JSON.stringify({
              dependencyScan: '${{ needs.dependency-scan.result }}',
              containerScan: '${{ needs.container-scan.result }}',
              secretScan: '${{ needs.secret-scan.result }}',
              sastScan: '${{ needs.sast-scan.result }}',
              infrastructureScan: '${{ needs.infrastructure-scan.result }}',
              licenseCompliance: '${{ needs.license-compliance.result }}',
              policyValidation: '${{ needs.policy-validation.result }}'
            }, null, 2)}

            ### ğŸš¨ Immediate Actions Required:
            1. Review the failed security checks in the workflow
            2. Address any critical vulnerabilities immediately
            3. Update dependencies with known security issues
            4. Remove any exposed secrets or credentials
            5. Review and update security policies

            ### ğŸ“„ Resources:
            - [Security Workflow Results](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Security Tab](${context.payload.repository.html_url}/security)
            - [Security Policy](${context.payload.repository.html_url}/security/policy)

            **Priority**: ğŸ”´ High - Address immediately
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'critical', 'audit-failure']
            });
