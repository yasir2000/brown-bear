name: ðŸ“¦ Dependencies Update

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - all

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'
  PHP_VERSION: '8.0'

jobs:
  # =====================================================
  # Dependency Analysis
  # =====================================================
  analyze-dependencies:
    name: ðŸ” Analyze Dependencies
    runs-on: ubuntu-latest
    outputs:
      js-updates: ${{ steps.check-js.outputs.updates }}
      php-updates: ${{ steps.check-php.outputs.updates }}
      security-updates: ${{ steps.security.outputs.updates }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          composer install --no-dev --optimize-autoloader

      - name: ðŸ” Check JavaScript Updates
        id: check-js
        run: |
          echo "ðŸ” Checking for JavaScript/TypeScript updates..."

          # Check for outdated packages
          pnpm outdated --format json > js-outdated.json || true

          if [ -s js-outdated.json ]; then
            echo "updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ JavaScript updates available" >> $GITHUB_STEP_SUMMARY
          else
            echo "updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All JavaScript packages are up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check PHP Updates
        id: check-php
        run: |
          echo "ðŸ” Checking for PHP updates..."

          # Check for outdated packages
          composer outdated --format=json > php-outdated.json || true

          if [ -s php-outdated.json ]; then
            echo "updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ PHP updates available" >> $GITHUB_STEP_SUMMARY
          else
            echo "updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All PHP packages are up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ›¡ï¸ Check Security Updates
        id: security
        run: |
          echo "ðŸ›¡ï¸ Checking for security updates..."

          # Check for security vulnerabilities
          pnpm audit --audit-level moderate --json > js-audit.json || true
          composer audit --format=json > php-audit.json || true

          if [ -s js-audit.json ] || [ -s php-audit.json ]; then
            echo "updates=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Security updates required" >> $GITHUB_STEP_SUMMARY
          else
            echo "updates=false" >> $GITHUB_OUTPUT
            echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: |
            js-outdated.json
            php-outdated.json
            js-audit.json
            php-audit.json
          retention-days: 30

  # =====================================================
  # Security Updates (Priority)
  # =====================================================
  security-updates:
    name: ðŸš¨ Security Updates
    runs-on: ubuntu-latest
    needs: [analyze-dependencies]
    if: needs.analyze-dependencies.outputs.security-updates == 'true'

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          composer install --no-dev --optimize-autoloader

      - name: ðŸš¨ Apply Security Updates
        run: |
          echo "ðŸš¨ Applying security updates..."

          # Update vulnerable JavaScript packages
          pnpm audit fix --audit-level moderate || true

          # Update vulnerable PHP packages
          composer audit --fix || true

          echo "âœ… Security updates applied" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run Tests
        run: |
          pnpm run test:unit
          pnpm run lint

      - name: ðŸ“ Create Security Update PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸš¨ Security updates - $(date +'%Y-%m-%d')"
          title: "ðŸš¨ Security Updates - $(date +'%Y-%m-%d')"
          body: |
            ## ðŸš¨ Security Updates

            This PR contains security updates for vulnerable dependencies.

            ### ðŸ” Changes:
            - Updated JavaScript packages with security vulnerabilities
            - Updated PHP packages with security vulnerabilities

            ### âœ… Verification:
            - [x] Tests passing
            - [x] Linting checks passed
            - [x] Security vulnerabilities resolved

            **Priority**: ðŸ”´ High - Please review and merge ASAP
          branch: security-updates-${{ github.run_number }}
          labels: security,dependencies,high-priority

  # =====================================================
  # Regular Updates
  # =====================================================
  regular-updates:
    name: ðŸ“¦ Regular Updates
    runs-on: ubuntu-latest
    needs: [analyze-dependencies]
    if: (needs.analyze-dependencies.outputs.js-updates == 'true' || needs.analyze-dependencies.outputs.php-updates == 'true') && github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        update-type: ['javascript', 'php']

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        if: matrix.update-type == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        if: matrix.update-type == 'javascript'
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ˜ Setup PHP
        if: matrix.update-type == 'php'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: ðŸ“¦ Update JavaScript Dependencies
        if: matrix.update-type == 'javascript'
        run: |
          echo "ðŸ“¦ Updating JavaScript dependencies..."

          case "${{ github.event.inputs.update_type }}" in
            "patch")
              pnpm update --latest --depth 0
              ;;
            "minor")
              pnpm update --latest
              ;;
            "major")
              pnpm update --latest --interactive=false
              ;;
            "all")
              pnpm update --latest --interactive=false
              ;;
          esac

      - name: ðŸ“¦ Update PHP Dependencies
        if: matrix.update-type == 'php'
        run: |
          echo "ðŸ“¦ Updating PHP dependencies..."

          case "${{ github.event.inputs.update_type }}" in
            "patch")
              composer update --with-dependencies --prefer-lowest
              ;;
            "minor")
              composer update --with-dependencies
              ;;
            "major")
              composer update --with-dependencies --ignore-platform-reqs
              ;;
            "all")
              composer update --with-dependencies --ignore-platform-reqs
              ;;
          esac

      - name: ðŸ§ª Run Tests
        run: |
          if [ "${{ matrix.update-type }}" == "javascript" ]; then
            pnpm install
            pnpm run test:unit
            pnpm run lint
            pnpm run typecheck
          fi

          if [ "${{ matrix.update-type }}" == "php" ]; then
            composer install
            vendor/bin/phpunit --configuration tests/phpunit.xml
          fi

      - name: ðŸ“ Create Update PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ“¦ ${{ matrix.update-type }} dependency updates - $(date +'%Y-%m-%d')"
          title: "ðŸ“¦ ${{ matrix.update-type }} Dependency Updates - $(date +'%Y-%m-%d')"
          body: |
            ## ðŸ“¦ ${{ matrix.update-type }} Dependency Updates

            This PR contains regular dependency updates for ${{ matrix.update-type }} packages.

            ### ðŸ”§ Update Type: ${{ github.event.inputs.update_type }}

            ### âœ… Verification:
            - [x] Tests passing
            - [x] Linting checks passed
            - [x] Type checking passed (JavaScript/TypeScript)

            ### ðŸ“‹ Review Checklist:
            - [ ] Check for breaking changes in updated packages
            - [ ] Verify application functionality
            - [ ] Review package changelogs for important updates

            **Type**: ${{ github.event.inputs.update_type }} updates
          branch: ${{ matrix.update-type }}-updates-${{ github.run_number }}
          labels: dependencies,${{ matrix.update-type }},maintenance

  # =====================================================
  # Dependency Health Report
  # =====================================================
  health-report:
    name: ðŸ“Š Dependency Health Report
    runs-on: ubuntu-latest
    needs: [analyze-dependencies]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: dependency-analysis

      - name: ðŸ“Š Generate Health Report
        run: |
          echo "# ðŸ“¦ Dependency Health Report" > dependency-health-report.md
          echo "" >> dependency-health-report.md
          echo "**Date:** $(date)" >> dependency-health-report.md
          echo "**Repository:** ${{ github.repository }}" >> dependency-health-report.md
          echo "" >> dependency-health-report.md

          echo "## ðŸ“Š Summary" >> dependency-health-report.md
          echo "" >> dependency-health-report.md
          echo "| Category | Status | Updates Available |" >> dependency-health-report.md
          echo "|----------|--------|--------------------|" >> dependency-health-report.md
          echo "| JavaScript/TypeScript | ${{ needs.analyze-dependencies.outputs.js-updates == 'true' && 'âš ï¸ Updates Available' || 'âœ… Up to Date' }} | ${{ needs.analyze-dependencies.outputs.js-updates }} |" >> dependency-health-report.md
          echo "| PHP | ${{ needs.analyze-dependencies.outputs.php-updates == 'true' && 'âš ï¸ Updates Available' || 'âœ… Up to Date' }} | ${{ needs.analyze-dependencies.outputs.php-updates }} |" >> dependency-health-report.md
          echo "| Security | ${{ needs.analyze-dependencies.outputs.security-updates == 'true' && 'ðŸš¨ Action Required' || 'âœ… Secure' }} | ${{ needs.analyze-dependencies.outputs.security-updates }} |" >> dependency-health-report.md
          echo "" >> dependency-health-report.md

          # Add detailed analysis if files exist
          if [ -f js-outdated.json ] && [ -s js-outdated.json ]; then
            echo "## ðŸ“¦ JavaScript/TypeScript Updates Available" >> dependency-health-report.md
            echo "\`\`\`json" >> dependency-health-report.md
            cat js-outdated.json >> dependency-health-report.md
            echo "\`\`\`" >> dependency-health-report.md
            echo "" >> dependency-health-report.md
          fi

          if [ -f php-outdated.json ] && [ -s php-outdated.json ]; then
            echo "## ðŸ˜ PHP Updates Available" >> dependency-health-report.md
            echo "\`\`\`json" >> dependency-health-report.md
            cat php-outdated.json >> dependency-health-report.md
            echo "\`\`\`" >> dependency-health-report.md
            echo "" >> dependency-health-report.md
          fi

          echo "## ðŸŽ¯ Recommendations" >> dependency-health-report.md
          echo "" >> dependency-health-report.md
          echo "### Security Updates" >> dependency-health-report.md
          echo "- ðŸš¨ Apply security updates immediately when available" >> dependency-health-report.md
          echo "- ðŸ” Review security advisories for critical packages" >> dependency-health-report.md
          echo "" >> dependency-health-report.md
          echo "### Regular Updates" >> dependency-health-report.md
          echo "- ðŸ“¦ Update patch versions monthly" >> dependency-health-report.md
          echo "- ðŸ”„ Update minor versions quarterly" >> dependency-health-report.md
          echo "- ðŸŽ¯ Plan major version updates carefully" >> dependency-health-report.md
          echo "- ðŸ§ª Always run full test suite after updates" >> dependency-health-report.md

      - name: ðŸ“¤ Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-health-report
          path: dependency-health-report.md
          retention-days: 90

      - name: ðŸ“¢ Summary
        run: |
          echo "## ðŸ“¦ Dependency Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript Updates | ${{ needs.analyze-dependencies.outputs.js-updates == 'true' && 'âš ï¸ Available' || 'âœ… Current' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Updates | ${{ needs.analyze-dependencies.outputs.php-updates == 'true' && 'âš ï¸ Available' || 'âœ… Current' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Updates | ${{ needs.analyze-dependencies.outputs.security-updates == 'true' && 'ðŸš¨ Required' || 'âœ… Secure' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Detailed health report generated and uploaded**" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Notify Maintainers
  # =====================================================
  notify-maintainers:
    name: ðŸ“¢ Notify Maintainers
    runs-on: ubuntu-latest
    needs: [analyze-dependencies, security-updates, regular-updates]
    if: always() && (needs.analyze-dependencies.outputs.security-updates == 'true' || github.event_name == 'schedule')

    steps:
      - name: ðŸ“¢ Create Maintenance Issue
        if: needs.analyze-dependencies.outputs.security-updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Security Updates Required - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ðŸš¨ Security Updates Required

            **Date**: ${new Date().toISOString()}
            **Priority**: ðŸ”´ High

            Security vulnerabilities have been detected in project dependencies.

            ### ðŸ” Affected Areas:
            - JavaScript/TypeScript dependencies: ${{ needs.analyze-dependencies.outputs.js-updates == 'true' && 'Updates available' || 'No updates' }}
            - PHP dependencies: ${{ needs.analyze-dependencies.outputs.php-updates == 'true' && 'Updates available' || 'No updates' }}

            ### ðŸš¨ Action Required:
            1. Review the automated security update PR
            2. Test the updates thoroughly
            3. Merge the security updates ASAP
            4. Monitor for any issues after deployment

            ### ðŸ“„ Resources:
            - [Dependency Update Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Security Tab](${context.payload.repository.html_url}/security)

            **This issue will be auto-closed when security updates are applied.**
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'dependencies', 'high-priority', 'maintenance']
            });

      - name: ðŸ“Š Weekly Summary
        if: github.event_name == 'schedule'
        run: |
          echo "## ðŸ“¦ Weekly Dependency Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Current Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **JavaScript Dependencies**: ${{ needs.analyze-dependencies.outputs.js-updates == 'true' && 'Updates Available âš ï¸' || 'Up to Date âœ…' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PHP Dependencies**: ${{ needs.analyze-dependencies.outputs.php-updates == 'true' && 'Updates Available âš ï¸' || 'Up to Date âœ…' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Status**: ${{ needs.analyze-dependencies.outputs.security-updates == 'true' && 'Action Required ðŸš¨' || 'Secure âœ…' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- Use manual workflow dispatch to apply regular updates" >> $GITHUB_STEP_SUMMARY
          echo "- Review and merge any security update PRs" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor dependency health reports" >> $GITHUB_STEP_SUMMARY
